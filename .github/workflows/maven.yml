# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI with Maven

on:
  push:
    branches: '**'
  pull_request:
    branches: '**'

jobs:
  build:

    runs-on: ubuntu-latest

    services:
      engine-plan:
        image: opentosca/ode:latest
        ports:
          - 9763:9763
      engine-ia:
        image: opentosca/engine-ia:latest
        ports:
          - 8099:8080

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    - name: Setup Docker Remote API
      run: sudo sed -ie "s@ExecStart=\/usr\/bin\/dockerd -H fd:\/\/@ExecStart=\/usr\/bin\/dockerd -H fd:\/\/ -H tcp:\/\/0.0.0.0:2375 -H unix:///var/run/docker.sock@g" /lib/systemd/system/docker.service
    - name: Setup DOCKER_OPTS
      run: sudo echo 'DOCKER_OPTS="-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock"' >> /etc/default/docker
    - name: Reload Deamones
      run: sudo systemctl daemon-reload
    - name: Restart Docker
      run: sudo service docker restart
    - name: Configure runtime with test properties
      run: cp test.properties ./org.opentosca.container.core/src/main/resources/application.properties
    - name: Show application properties
      run: cat ./org.opentosca.container.core/src/main/resources/application.properties
    - name: Test Docker Remote API
      run: curl -X GET http://localhost:2375/images/json
    - name: Build with Maven
      run: mvn -B package --file pom.xml --fail-at-end
